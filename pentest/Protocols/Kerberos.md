Протокол аутентификации, позволяющий клиентам получить доступ к сервису от имени пользователя ([[Security principals]]). Это протокол взаимной аутентифакации до установления безопасного соединения. Описан в документе [[RFC4120]].

Протокол не занимается авторизацией пользователей, т.е. не знает о факте того есть у пользователя доступ к сервису или нет. 
## Структура

**[[Key Distribution Center (KDC)]]** 

___
## Схема работы протокола

### Предварительная аутентификация, получение билета TGT
Пользователь логиниться в сеть вводя логин и пароль. Клиент *Kerberos* на компьютере пользователя генерирует криптографический ключ шифрования на основе пароля пользователя (*User master key*). 
1. Клиент запрашивает доступ к службе *TGS* сервиса [[Key Distribution Center (KDC)]], отпраляя сервису сообщение `KRB_AS_REQ (Kerberos Authentication Service Request)`. Сообщение состоит из:
	- UPN (UserPrincipalName)
	- `"krbtgt"`
	- timestamp
2. После получения сообщения *KDC* достает *User master key* из базы данных и расшифровывает полученное сообщение, сравнивает метку времени, если она валидна, значит сообщения было зашифровано с помощью *User master key*, соответсвенно клиент подлинный, иначе нет.
3. *KDC* возвращает сообщение `KRB_AS_REP`, содержащее: 
	1. Билет *TGS* зашифрованный с помощью пароля учетной записи `"krbtgt"` (KDC's master key).
	2. Сеансовый ключ пользователя (*session key*), зашифрованный с помощью *User master key*. Данный ключ будет использоваться для шифрования последующих сообщений к DC.
4. Пользователь дешифрует сессионный ключ и кладет его вместе с билетом в кэш.

_____
### Получение билета TGS для конкретного сервиса

После того как билет *TGT* и *session key* были получены пользователь может запрашивать билеты и сеансовые ключи для доступа к конкретному сервису. 
Алгоритм получения билета:
1. Клиент запрашивает доступ к сервису, отправляя *KDC* сообщение `KRB_TGS_REQ (Kerberos Ticket-Granting Service Request)`. Сообщение содержит: SPN, UPN, timestamp. Сообщение шифруется полученным ранее *session key* и к нему присоединяется билет *TGT*.
2. *KDC* извелкает билет *TGT*, дешифрует его своим ключом (*KDC master key*). Затем извелкает пользовательскую информцию и дешифрует ее с помощью *session key*.
3. Проверяется валидность временной метки, если метка верна *KDC* извлекает пользовательскую информацию из билета *TGT* и создает новый сессионный ключ для общения пользователя и запрашиваемого сервера (*Service session key*). Данный ключ шифруется с помощью *user session key*.
4. Создается билет *TGS*, в него вставляется *Service session key* и информация и пользователи, билет ширфуется мастер ключом **==сервиса==** и присоединяется к сообщению.
5. Отправляется сообщение `KRB_TGS_REP (Kerberos Ticket-Granting Service Reply)` обратно пользователю.
6. Пользователь дешифрует сессионный ключ и кладет его вместе с билетом в кэш.

Факт того, что в шаге 4 билет *TGS* шифруется с помощью сессиного ключа сервиса, который в свою очередь строится из хэша пароля сервиса позволяет осуществить атаку [[Kerberoasting]].
