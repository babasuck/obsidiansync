Атака, нацеленная на получение хэша пароля сервисной учетной записи. Возможна за счет особенности работы протокола [[Kerberos]].

*Предварительный требования* - учетная запись пользователя домена с любым уровнем привилегий, доступ к UDP/88 контроллера домена.
## Проведние атаки

1. Атакующий авторизуется в *AS* службе сервиса *KDC*, отправляя сообщение `AS_REQ` и получая `AS_REP`.
2. Атакующий использует билет *TGT* для запроса билета *TGS* для конкретного *SPN*(отправляет `TGS_REQ`). Атакующий имеет право на данный запрос, так как авторизация не проводится в рамках протокола [[Kerberos]].
3. Атакующий извелкает хэш зашифрованного билета *TGS* из сообщения `TGS_REP`
4. Полученный хэш может быть подвергнут перебору (hashcat 13100)

## Known misconfiguration

Есть пользователи с настройкой 'Do not require Kerberos preauthentication', которые могут получать *TGT* билеты сразу без ввода пароля. Можно извлечь хэш пароля из *TGT* и перебрать.

Извлечь таких юзеров и их *TGT*
`GetNPUsers.py`
```bash
GetNPUsers.py -dc-ip 172.20.4.2 domain/user:password
```
## Attack tools

| Name                          | Desc.                                                        | Windows | Linux |
| ----------------------------- | ------------------------------------------------------------ | ------- | ----- |
| [[Impacket]] `GetUserSPNs.py` | извлекает хэши из *TGS* у всех сервисных учеток или по имени | +       | +     |
|                               |                                                              | +       | +     |
|                               |                                                              |         |       |
|                               |                                                              |         |       |
